.PHONY: deploy-all deploy check-health

deploy:
	@echo "üöÄ Iniciando deploy na EC2 remota..."
	@for i in $$(seq 1 3); do \
		echo "Tentativa $$i de 3..."; \
		if ssh -o BatchMode=yes ec2 'cd /repo/easytrade && \
			export $$(cat dynatrace.env | xargs) && \
			docker compose pull && \
			docker compose up --force-recreate --remove-orphans --detach'; then \
			echo "‚úÖ Deploy iniciado com sucesso!"; \
			break; \
		fi; \
		if [ "$$i" = "3" ]; then \
			echo "‚ùå Falha no deploy ap√≥s 3 tentativas"; \
			exit 1; \
		fi; \
		echo "‚è≥ Aguardando 10 segundos antes da pr√≥xima tentativa..."; \
		sleep 10; \
	done

check-health:
	@echo "üîç Verificando sa√∫de dos containers na EC2..."
	@echo "‚è≥ Aguardando inicializa√ß√£o dos containers..."
	@for i in $$(seq 1 6); do \
		echo "Tentativa $$i de 6..."; \
		sleep 10; \
		if ssh -o BatchMode=yes ec2 'docker ps --format "{{.Names}} - {{.Status}}" | grep -i "up" | wc -l' > /dev/null; then \
			CONTAINERS_UP=$$(ssh -o BatchMode=yes ec2 'docker ps --format "{{.Names}} - {{.Status}}" | grep -i "up" | wc -l'); \
			CONTAINERS_TOTAL=$$(ssh -o BatchMode=yes ec2 'docker ps --format "{{.Names}}" | wc -l'); \
			if [ "$$CONTAINERS_UP" = "$$CONTAINERS_TOTAL" ]; then \
				echo "‚úÖ Todos os containers est√£o em execu√ß√£o!"; \
				break; \
			fi; \
		fi; \
		if [ "$$i" = "6" ]; then \
			echo "‚ùå Timeout: Nem todos os containers iniciaram ap√≥s 60 segundos"; \
			ssh -o BatchMode=yes ec2 'docker ps --format "{{.Names}} - {{.Status}}"'; \
			exit 1; \
		fi; \
	done
	@echo "üîç Verificando status de sa√∫de..."
	@if ssh -o BatchMode=yes ec2 'docker ps --format "{{.Names}} - {{.Status}}" | grep -i "unhealthy" | wc -l' > /dev/null; then \
		UNHEALTHY=$$(ssh -o BatchMode=yes ec2 'docker ps --format "{{.Names}} - {{.Status}}" | grep -i "unhealthy" | wc -l'); \
		if [ "$$UNHEALTHY" -gt 0 ]; then \
			echo "‚ö†Ô∏è Containers unhealthy encontrados:"; \
			ssh -o BatchMode=yes ec2 'docker ps --format "{{.Names}} - {{.Status}}" | grep -i "unhealthy"'; \
			exit 1; \
		else \
			echo "‚úÖ Todos os containers est√£o saud√°veis!"; \
		fi; \
	else \
		echo "‚ùå Erro ao verificar status dos containers"; \
		exit 1; \
	fi

deploy-all: deploy check-health
	@echo "‚ú® Deploy finalizado com sucesso!" 